<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Records and Information Administration</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      let randomNumber = localStorage.getItem('randomNumber');
      let email = localStorage.getItem('email');
      
      function primary() {      
        if ((!email) || (email == null)) {
          document.getElementById('authorization-status').innerHTML = `You are not signed in. Press the button below to sign in. Use the account you use for other Pathos purposes, such as documentation.<br><span style="font-size:11px;">By signing in, you consent to the use of local storage for session continuity. No cookies are used. You may view our Privacy Policy <a href="policy.html" target="_blank">here</a>.</span>`;
        } else {
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?randomNumber=${randomNumber}&email=${encodeURIComponent(email)}&type=0`, {
          method: 'POST',
          headers: {
            'Referer': window.location.origin, // Add Referer header to verify request origin
          },
        }).then(response => {
          if (response.ok) {
            return response.json(); // Parse JSON response
          } else {
            throw new Error('Failed to fetch response.');
          }
        }).then(data => {
          var result = data.result; // Store the response in the variable
          console.log(result)
          if (result == "Failed") {
                  document.getElementById('authorization-status').innerHTML = `You are not signed in. Press the button below to sign in. Use the account you use for other Pathos purposes, such as documentation.<br><span style="font-size:11px;">By signing in, you consent to the use of local storage for session continuity. No cookies are used. You may view our Privacy Policy <a href="https://pathos-sd.github.io/access-terminal/policy" target="_blank">here</a>.</span>`;
                } else {
                  document.getElementById('authorization-status').innerHTML = `You are signed in as ${email}. Use the button below to change your account.<br><span style="font-size:11px;">By signing in, you consent to the use of local storage for session continuity. No cookies are used. You may view our Privacy Policy <a href="https://pathos-sd.github.io/access-terminal/policy" target="_blank">here</a>.</span>`;
                  var parameter = window.location.href.split("?")[1]
                  if (parameter == undefined) {
                    document.getElementById('buttons').innerHTML = `<button class="styled green" onclick="loadSnippet('look-up', 'dashboard');" type="submit">Look-Up</button>
        <button class="styled green" onclick="handleMenu(42);" type="submit">Action Submission</button>
        <button class="styled green" onclick="handleMenu(43);" type="submit">Action Review</button>`
                  } else {
                      document.getElementById("dashboard").innerHTML = "Processing your request. This may take a few seconds..."
                      fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&caseId=${encodeURIComponent(parameter)}&type=412P`, {
                        method: 'POST'
                      }).then(response => {
                        if (response.ok) {
                          return response.json()
                        } else {
                          throw new Error ('Failed to fetch response.')
                        }
                      }).then(data => {
                        var result = data.result; // Store the response in the variable
                        document.getElementById('dashboard').innerHTML = result;
                        console.log('Traffic Server Response: ', result);
                      }).catch(error => {
                        console.error("Error:", error)
                      })
                  }
                }
                return result; // Parse JSON response
        }).catch(error => {
          console.error('Error:', error);
        });
        }
      }

      function loadSnippet(elementId, targetId) {
        var url = "mpsnippets.html"
        try {
          fetch(url).then(response => {
            if (!response.ok) {
              console.error("Failed to fetch content");
              throw new Error("Failed to fetch content");
            }
            var text = response.text()
          })

          let parser = new DOMParser()
          let content = parser.parseFromString(text, "text/html").getElementById(elementId.toUpperCase())

          document.getElementById(targetId).innerHTML = content.innerHTML
        } catch {
          console.error("Error loading snippet:", error)
        }
      }
      
      function handleMenu(type) {
        if (type == 4) {
          document.getElementById('form-body').innerHTML = `                `
        } else if (type == 41) {
            document.getElementById('form-body').innerHTML = `                <button id="traffic-button" onclick="handleMenu(41);" type="submit">Look-Up</button>
        <button id="traffic-button" onclick="handleMenu(42);" type="submit">Action Submission</button>
        <button id="traffic-button" onclick="handleMenu(43);" type="submit">Action Review</button>
        <h3 style="margin-bottom:15px">MP Traffic Dashboard: Look-Up</h3>
        <form id="type41-form" style="line-height:10px" onsubmit="handleType4Form(event, 1)">
        <label for="lookupType">Look-Up Type:</label><br><br>
        <select id="lookupType" name="lookupType" onchange="handleMenu(value)" required>
            <option value="410"></option>
            <option value="411">Summary User Look-Up</option>
            <option value="412">Case Look-Up by Ref #</option>
            <option value="413">Full User Records</option>
        </select><br><br><br>
        <div id="lookupInput">
      
        </div>
        </form>
        <p id="type41-response"><br></p>
        <p id="type4332-response"><br></p>`
        } else if (type == 410) {
          document.getElementById('lookupInput').innerHTML = ``
        } else if (type == 411) {
          document.getElementById('lookupInput').innerHTML = `                
      <label for="inputQuery">Subject's Username:</label><br><br>
      <input type="text" id="inputQuery" name="inputQuery" placeholder="Vasek_Stolba" required maxlength="20"><br><br>
      
      <button id="search-button" type="submit">Submit</button>`
        } else if (type == 412) {
          document.getElementById('lookupInput').innerHTML = `                
      <label for="inputQuery">Reference Number:</label><br><br>
      <input type="number" id="inputQuery" name="inputQuery" placeholder="321" required min="1" max="999"><br><br>
      
      <button id="search-button" type="submit">Submit</button>`
        } else if (type == 413) {
          document.getElementById('lookupInput').innerHTML = `                
      <label for="inputQuery">Subject's Username:</label><br><br>
      <input type="text" id="inputQuery" name="inputQuery" placeholder="Vasek_Stolba" required maxlength="20"><br><br>
      
      <button id="search-button" type="submit" disabled>Submit</button><span style="font-size:10px"><br>This feature is not functional at this time.</span>`
        } else if (type == 42) {
          document.getElementById('form-body').innerHTML = `                <button id="traffic-button" onclick="handleMenu(41);" type="submit">Look-Up</button>
        <button id="traffic-button" onclick="handleMenu(42);" type="submit">Action Submission</button>
        <button id="traffic-button" onclick="handleMenu(43);" type="submit">Action Review</button>
      <h3 style="margin-bottom:15px">MP Traffic Dashboard: Action Submission</h3>
      <form id="type42-form" style="line-height:10px" onsubmit="handleType4Form(event, 2)">
      <label for="inputusername">Defendant's Username:</label><br><br>
      <input type="text" id="inputUsername" name="inputUsername" placeholder="Vasek_Stolba" required maxlength="20"><br><br><br>
      
      <label for="">Charges:</label><br><br>
      <input type="checkbox" id="checkbox_0" name="" value="Reckless Driving (a)">
      <label for="checkbox_0">Reckless Driving (a)</label><br>
      <input type="checkbox" id="checkbox_1" name="" value="Causing a Severe Collision by Reckless Driving (b)">
      <label for="checkbox_1">Causing a Severe Collision by Reckless Driving (b)</label><br>
      <input type="checkbox" id="checkbox_2" name="" value="Careless Driving (c)">
      <label for="checkbox_2">Careless Driving (c)</label><br>
      <input type="checkbox" id="checkbox_3" name="" value="Disobeying a traffic authority (d) i.">
      <label for="checkbox_3">Disobeying a traffic authority (d) i.</label><br>
      <input type="checkbox" id="checkbox_4" name="" value="Speeding around a traffic authority (d) ii.">
      <label for="checkbox_4">Speeding around a traffic authority (d) ii.</label><br>
      <input type="checkbox" id="checkbox_5" name="" value="Failure to yield (e)">
      <label for="checkbox_5">Failure to yield (e)</label><br>
      <input type="checkbox" id="checkbox_6" name="" value="Failure to yield to emergency vehicles (f)">
      <label for="checkbox_6">Failure to yield to emergency vehicles (f)</label><br>
      <input type="checkbox" id="checkbox_7" name="" value="Speeding (g)">
      <label for="checkbox_7">Speeding (g)</label><br>
      <input type="checkbox" id="checkbox_8" name="" value="Obstructing Traffic (h)">
      <label for="checkbox_8">Obstructing Traffic (h)</label><br>
      <input type="checkbox" id="checkbox_9" name="" value="Parking in an Improper Manner (i)">
      <label for="checkbox_9">Parking in an Improper Manner (i)</label><br>
      <input type="checkbox" id="checkbox_10" name="" value="Disobeying a Traffic Control Device (j)">
      <label for="checkbox_10">Disobeying a Traffic Control Device (j)</label><br>
      <input type="checkbox" id="checkbox_11" name="" value="Causing a Severe Collision (k)">
      <label for="checkbox_11">Causing a Severe Collision (k)</label><br>
      <input type="checkbox" id="checkbox_12" name="" value="Criminal Offense related to traffic (l)">
      <label for="checkbox_12">Criminal Offense related to traffic (l)</label><br>
      <input type="checkbox" id="checkbox_13" name="" value="Serious Criminal Offense related to traffic (m)">
      <label for="checkbox_13">Serious Criminal Offense related to traffic (m)</label><br>
      <input type="checkbox" id="checkbox_14" name="" value="Misuse of Emergency Equipment (n) i.">
      <label for="checkbox_14">Misuse of Emergency Equipment (n) i.</label><br>
      <input type="checkbox" id="checkbox_15" name="" value="Misuse of Miscellaneous Equipment (n) ii.">
      <label for="checkbox_15">Misuse of Miscellaneous Equipment (n) ii.</label><br>
      <input type="checkbox" id="checkbox_16" name="" value="Misuse of Aircrafts (n) iii.">
      <label for="checkbox_16">Misuse of Aircrafts (n) iii.</label><br>
      <input type="checkbox" id="checkbox_17" name="" value="Unauthorized Operation of Special Vehicles (o)">
      <label for="checkbox_17">Unauthorized Operation of Special Vehicles (o)</label><br><br><br>
      
      <label for="offenseSummary">Offense Summary:</label><br><br>
      <textarea style="height:120px" id="offenseSummary" name="offenseSummary" placeholder="As I was driving past the Epsilon × Phi × IC intersection, traveling in the direction from Site Epsilon, I observed the defendant, who was driving the vehicle ahead of me, fail to yield to oncoming traffic as he made a left turn, colliding with an oncoming vehicle." required></textarea><br><br><br>
      
      <label for="evidence">Evidence:<span style="font-size:10px"><br>Include nothing but links. Separate links by line breaks. One line per link.</span></label><br><br>
      <textarea style="height:120px" id="evidence" name="evidence" placeholder="https://example.com/evidence-a
https://example.com/evidence-b" required></textarea><br><br><br>
      
      <label for="notes">Notes:</label><br><br>
      <textarea style="height:60px" id="notes" name="notes" placeholder="(Optional) The offender was ordered not to drive..."></textarea><br><br>
      
      <button id="search-button" type="submit">Submit</button>
      </form>
      <p id="type42-response"><br></p>`
        } else if (type == 43) {
            document.getElementById('form-body').innerHTML = `                <button id="traffic-button" onclick="handleMenu(41);" type="submit">Look-Up</button>
        <button id="traffic-button" onclick="handleMenu(42);" type="submit">Action Submission</button>
        <button id="traffic-button" onclick="handleMenu(43);" type="submit">Action Review</button>
        <h3 style="margin-bottom:0px;padding-bottom:0px">MP Traffic Dashboard: Action Review</h3><p style="font-size:10px;margin-top:1px;padding-top:0px;margin-bottom:15px">Select the record you want to edit either by specifying the reference number or opening the List of Pending Cases.</p>
        <form id="type43-form" style="line-height:10px" onsubmit="handleType4Form(event, 431)">
          <label for="inputCaseId">Reference Number:</label><br><br>
          <input type="number" id="inputCaseId" name="inputCaseId" placeholder="321" required min="1" max="999"><br><br>
      
          <button id="search-button" type="submit">Select</button>
        </form>
        <p id="type43-response"><br></p>
        <button id="traffic-button" onclick="handleType4Form('', 433)" type="submit">List of Pending Cases</button>
        <p id="type433-response"><br></p>
        <p id="type4332-response"><br></p>`
        } else if ((type == "none")+(type == "traffic warning")+(type == "revocation of driving privileges")) {
            document.getElementById('sentenceDuration').value = ""
            document.getElementById('sentenceDuration').disabled = true
        } else if (type == "suspension of driving privileges") {
            document.getElementById('sentenceDuration').value = ""
            document.getElementById('sentenceDuration').disabled = false
        }
      }
      
      function handleCredentialResponse(response) {
        try {
          // Decode JWT to get the user's email
          const payload = JSON.parse(atob(response.credential.split('.')[1]));
          email = payload.email;
          randomNumber = Math.floor(100000000 + Math.random() * 900000000).toString(); // Generate random 9-digit number
          localStorage.setItem('randomNumber', randomNumber); // Store it locally
          localStorage.setItem('email', email);
          // Send the email and random number to your endpoint
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?randomNumber=${randomNumber}&type=1&token=${encodeURIComponent(response.credential)}`, {
            method: 'POST',
          }).then(response => {
            if (response.ok) {
              console.log(response)
              location.reload();
              return response; // Parse JSON response
            } else {
              throw new Error('Failed to fetch response.');
            }
          }).catch(error => {
            console.error('Error:', error);
          });
        } catch (error) {
          console.error('Failed to parse credential response:', error);
        }
      }
           
      function handleType433Form(subtype, query) {
        if (subtype == "view") {
          document.getElementById("type4332-response").innerHTML = "Processing your request. This may take a few seconds..."
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&caseId=${encodeURIComponent(query)}&type=412`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            var result = data.result; // Store the response in the variable
            document.getElementById('type4332-response').innerHTML = result;
            document.getElementById("search-button").disabled = false
            console.log('Traffic Server Response: ', result);
          }).catch(error => {
            console.error("Error:", error)
          })
        }
        if (subtype == "edit") {
        document.getElementById("type4332-response").innerHTML = "Processing your request. This may take a few seconds..."
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&caseId=${encodeURIComponent(query)}&type=431`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            if (data.message != "Success!") {
              document.getElementById('type4332-response').innerHTML = data.message
              return true
            } else {
              console.log(data.charges.includes("Reckless Driving (a)"))
              document.getElementById('form-body').innerHTML = `      <button id="traffic-button" onclick="handleMenu(41);" type="submit">Look-Up</button>
      <button id="traffic-button" onclick="handleMenu(42);" type="submit">Action Submission</button>
      <button id="traffic-button" onclick="handleMenu(43);" type="submit">Action Review</button>
    <h3 style="margin-bottom:0px;padding-bottom:0px">MP Traffic Dashboard: Action Review</h3><p style="font-size:10px;margin-top:1px;padding-top:0px;margin-bottom:15px">Case <span id="editingCaseRefId">${data.refId}</span>, submitted by ${data.submittedBy}</p>
    
    <form id="type43-form" style="line-height:10px" onsubmit="handleType4Form(event, 432)">

    <label for="inputusername">Defendant's Username:</label><br><br>
    <input type="text" id="inputUsername" name="inputUsername" placeholder="Vasek_Stolba" required maxlength="20" value="${data.defendantUser}"><br><br><br>
    
    <label for="">Charges:</label><br><br>
    <input type="checkbox" id="checkbox_0" name="" value="Reckless Driving (a)" ${data.charges[0]}">
    <label for="checkbox_0">Reckless Driving (a)</label><br>
    <input type="checkbox" id="checkbox_1" name="" value="Causing a Severe Collision by Reckless Driving (b)" ${data.charges[1]}>
    <label for="checkbox_1">Causing a Severe Collision by Reckless Driving (b)</label><br>
    <input type="checkbox" id="checkbox_2" name="" value="Careless Driving (c)" ${data.charges[2]}>
    <label for="checkbox_2">Careless Driving (c)</label><br>
    <input type="checkbox" id="checkbox_3" name="" value="Disobeying a traffic authority (d) i." ${data.charges[3]}>
    <label for="checkbox_3">Disobeying a traffic authority (d) i.</label><br>
    <input type="checkbox" id="checkbox_4" name="" value="Speeding around a traffic authority (d) ii." ${data.charges[4]}>
    <label for="checkbox_4">Speeding around a traffic authority (d) ii.</label><br>
    <input type="checkbox" id="checkbox_5" name="" value="Failure to yield (e)" ${data.charges[5]}>
    <label for="checkbox_5">Failure to yield (e)</label><br>
    <input type="checkbox" id="checkbox_6" name="" value="Failure to yield to emergency vehicles (f)" ${data.charges[6]}>
    <label for="checkbox_6">Failure to yield to emergency vehicles (f)</label><br>
    <input type="checkbox" id="checkbox_7" name="" value="Speeding (g)" ${data.charges[7]}>
    <label for="checkbox_7">Speeding (g)</label><br>
    <input type="checkbox" id="checkbox_8" name="" value="Obstructing Traffic (h)" ${data.charges[8]}>
    <label for="checkbox_8">Obstructing Traffic (h)</label><br>
    <input type="checkbox" id="checkbox_9" name="" value="Parking in an Improper Manner (i)" ${data.charges[9]}>
    <label for="checkbox_9">Parking in an Improper Manner (i)</label><br>
    <input type="checkbox" id="checkbox_10" name="" value="Disobeying a Traffic Control Device (j)" ${data.charges[10]}>
    <label for="checkbox_10">Disobeying a Traffic Control Device (j)</label><br>
    <input type="checkbox" id="checkbox_11" name="" value="Causing a Severe Collision (k)" ${data.charges[11]}>
    <label for="checkbox_11">Causing a Severe Collision (k)</label><br>
    <input type="checkbox" id="checkbox_12" name="" value="Criminal Offense related to traffic (l)" ${data.charges[12]}>
    <label for="checkbox_12">Criminal Offense related to traffic (l)</label><br>
    <input type="checkbox" id="checkbox_13" name="" value="Serious Criminal Offense related to traffic (m)" ${data.charges[13]}>
    <label for="checkbox_13">Serious Criminal Offense related to traffic (m)</label><br>
    <input type="checkbox" id="checkbox_14" name="" value="Misuse of Emergency Equipment (n) i." ${data.charges[14]}>
    <label for="checkbox_14">Misuse of Emergency Equipment (n) i.</label><br>
    <input type="checkbox" id="checkbox_15" name="" value="Misuse of Miscellaneous Equipment (n) ii." ${data.charges[15]}>
    <label for="checkbox_15">Misuse of Miscellaneous Equipment (n) ii.</label><br>
    <input type="checkbox" id="checkbox_16" name="" value="Misuse of Aircrafts (n) iii." ${data.charges[16]}>
    <label for="checkbox_16">Misuse of Aircrafts (n) iii.</label><br>
    <input type="checkbox" id="checkbox_17" name="" value="Unauthorized Operation of Special Vehicles (o)" ${data.charges[17]}>
    <label for="checkbox_17">Unauthorized Operation of Special Vehicles (o)</label><br><br><br>
    
    <label for="offenseSummary">Offense Summary:</label><br><br>
    <textarea style="height:120px" id="offenseSummary" name="offenseSummary" placeholder="As I was driving past the Epsilon × Phi × IC intersection, traveling in the direction from Site Epsilon, I observed the defendant, who was driving the vehicle ahead of me, fail to yield to oncoming traffic as he made a left turn, colliding with an oncoming vehicle." required>${data.offSummary}</textarea><br><br><br>
    
    <label for="evidence">Evidence:<span style="font-size:10px"><br>Include nothing but links. Separate links by line breaks. One line per link.</span></label><br><br>
    <textarea style="height:120px" id="evidence" name="evidence" placeholder="https://example.com/evidence-a
https://example.com/evidence-b" required>${data.evidence}</textarea><br><br><br>
    
    <label for="notes">Officer Notes:</label><br><br>
    <textarea style="height:60px" id="notes" name="notes" placeholder="(Optional) The offender was ordered not to drive...">${data.offNotes}</textarea><br><br>

    <hr class="rounded"><br><br>
    <input type="checkbox" id="checkbox_supervisor" name="" value="makeSupervisor" ${data.supervisorChecked}>
    <label for="checkbox_supervisor">Make me the case supervisor</label><br><br><br>

    <label for="offenseSummary">Supervisor Notes:</label><br><br>
    <textarea style="height:120px" id="supervisorNotes" name="supervisorNotes" placeholder="The evidence clearly demonstrates the suspect disobeying road markings and driving in the opposite lane consequently causing a vehicle incident, thus satisfying the charges pursuant to subsections (a) and (b) of the Traffic Code. The driver seems to be engaging in such a manner of driving frequently and persistently even after the incident, as further demonstrated by evidence B, satisfying the charge for reckless driving.

Considering the circumstances and statutory limitations on the punishment for such offenses, I believe it is suitable to issue a 8 day suspension of driving privileges, as even though the severity of the conduct is high, a more severe punishment would be suitable primarily for worse offenses with bigger impact." required>${data.supervisorNotes}</textarea><br><br><br>
    
    <label for="sentence">Sentence:</label><br><br>
    <select id="sentence" name="sentence" onchange="handleMenu(value)" required>
      <option value="none" ${data.sentence[0]}></option>
      <option value="traffic warning" ${data.sentence[1]}>Traffic Warning</option>
      <option value="suspension of driving privileges" ${data.sentence[2]}>Suspension</option>
      <option value="revocation of driving privileges" ${data.sentence[3]}>Revocation</option>
    </select><br><br><br>

    <label for="sentenceDuration">Sentence Duration:</label><br><br>
    <input type="number" id="sentenceDuration" name="sentenceDuration" value="${data.durationValue}" placeholder="(in days)" required min="1" max="10" ${data.duration}><br><br><br>

    <label for="status">Status:</label><br><br>
    <select id="status" name="status" required>
      <option value="Pending" ${data.status[0]}>Pending</option>
      <option value="Valid" ${data.status[1]}>Valid</option>
      <option value="Invalid" ${data.status[2]}>Invalid</option>
    </select><br><br>
    
    <button id="search-button" type="submit">Edit</button>
    </form>
    <p id="type43-response"><br></p>`
            }
          }).catch(error => {
            console.error("Error:", error)
          })
        }
      }
      
      function handleType4Form(event, subtype) {
        if (subtype == 1) {
                document.getElementById("search-button").disabled = true
         event.preventDefault()
      
                var lookupType = document.getElementById("lookupType").value
                var lookupInput = document.getElementById("inputQuery").value
      
                if (lookupType == 411) {
                        if (!/^[A-Za-z0-9_]{3,21}$/.test(lookupInput)) {
        	          document.getElementById("type41-response").innerHTML = "The username is invalid."
        	          document.getElementById("search-button").disabled = false
        	          return true
                 }
          document.getElementById("type41-response").innerHTML = "Processing your request. This may take a few seconds..."
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&username=${encodeURIComponent(lookupInput)}&type=411`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            document.getElementById("type41-response").innerHTML = data.result.replaceAll(/TIMESTAMP:(\d+)/g, (_, unixTimestamp) => {
      let date = new Date(Number(unixTimestamp));
      let year = String(date.getFullYear())
      let month = String(date.getMonth()+1).padStart(2, '0')
      let day = String(date.getDate()).padStart(2, '0')
      let hours = String(date.getHours()).padStart(2, '0')
      let minutes = String(date.getMinutes()).padStart(2, '0')
      return `${year}/${month}/${day} ${hours}:${minutes}`
      });
            document.getElementById("search-button").disabled = false
          }).catch(error => {
            console.error("Error:", error)
          })
                } else if (lookupType == 412) {
          document.getElementById("type41-response").innerHTML = "Processing your request. This may take a few seconds..."
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&caseId=${encodeURIComponent(lookupInput)}&type=412`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            var result = data.result; // Store the response in the variable
            document.getElementById('type41-response').innerHTML = result;
            document.getElementById("search-button").disabled = false
            console.log('Traffic Server Response: ', result);
          }).catch(error => {
            console.error("Error:", error)
          })
                } else if (lookupType == 413) {
                        if (!/^[A-Za-z0-9_]{3,21}$/.test(lookupInput)) {
        	          document.getElementById("type41-response").innerHTML = "The username is invalid."
        	          document.getElementById("search-button").disabled = false
        	          return true
                 }
          document.getElementById("type41-response").innerHTML = "Processing your request. This may take a few seconds..."
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&username=${encodeURIComponent(lookupInput)}&type=413`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            var result = data.result; // Store the response in the variable
            var link = data.link
            if (link == "") {
              document.getElementById('type41-response').innerHTML = result;
       document.getElementById("search-button").disabled = false
              console.log('Traffic Server Response: ', result);
            } else {
              window.open(link, "_blank")
              document.getElementById('type41-response').innerHTML = `If you were not automatically redirected, use <a href="${link}" target="_blank">this link</a>.`;
       document.getElementById("search-button").disabled = false
              console.log('Traffic Server Response: ', link);
            }
          }).catch(error => {
            console.error("Error:", error)
          })
                        
                }
        }
      if (subtype == 2) {
      document.getElementById("search-button").disabled = true
         event.preventDefault()
         var i = 0
         var charges = ""
         while (i < 18) {
           var checkbox = document.getElementById("checkbox_" + i)
           if (checkbox.checked) {
               if (charges == "") {
                 charges = checkbox.value
               } else {
                 charges += ";" + checkbox.value
               }
           }
           i = i+1
         }
         if (charges == "") {
           document.getElementById("type42-response").innerHTML = "Select at least one charge."
           document.getElementById("search-button").disabled = false
           return true
         }
         console.log(charges)
         
         var username = document.getElementById("inputUsername").value
         if (!/^[A-Za-z0-9_]{3,21}$/.test(username)) {
           document.getElementById("type42-response").innerHTML = "The username is invalid."
           document.getElementById("search-button").disabled = false
           return true
         }
         var offenseSummary = document.getElementById("offenseSummary").value.replaceAll(`
         `, "\r")
         var evidence = document.getElementById("evidence").value.replaceAll(`
         `, "\r")
         var notes = document.getElementById("notes").value.replaceAll(`
         `, "\r")
         
         document.getElementById("type42-response").innerHTML = "Processing your request. This may take a few seconds..."
         fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&username=${encodeURIComponent(username)}&charges=${encodeURIComponent(charges)}&offSummary=${encodeURIComponent(offenseSummary)}&evidence=${encodeURIComponent(evidence)}&notes=${encodeURIComponent(notes)}&type=42`, {
           method: 'POST'
         }).then(response => {
           if (response.ok) {
             return response.json()
           } else {
             throw new Error ('Failed to fetch response.')
           }
         }).then(data => {
           document.getElementById("type42-response").innerHTML = data.result
           if (data.result == "Your submission was successfully recorded in the traffic database.") {
             document.getElementById("type42-form").reset()
           }
           document.getElementById("search-button").disabled = false
         }).catch(error => {
           console.error("Error:", error)
         })
      }
      if (subtype == 431) {
        document.getElementById("search-button").disabled = true
        event.preventDefault()
        document.getElementById("type43-response").innerHTML = "Processing your request. This may take a few seconds..."
        var lookupInput = document.getElementById("inputCaseId").value
          fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&caseId=${encodeURIComponent(lookupInput)}&type=431`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              return response.json()
            } else {
              document.getElementById("search-button").disabled = false
              throw new Error ('Failed to fetch response.')
            }
          }).then(data => {
            if (data.message != "Success!") {
              document.getElementById('type43-response').innerHTML = data.message
              document.getElementById("search-button").disabled = false
              return true
            } else {
              console.log(data.charges.includes("Reckless Driving (a)"))
              document.getElementById('form-body').innerHTML = `      <button id="traffic-button" onclick="handleMenu(41);" type="submit">Look-Up</button>
      <button id="traffic-button" onclick="handleMenu(42);" type="submit">Action Submission</button>
      <button id="traffic-button" onclick="handleMenu(43);" type="submit">Action Review</button>
    <h3 style="margin-bottom:0px;padding-bottom:0px">MP Traffic Dashboard: Action Review</h3><p style="font-size:10px;margin-top:1px;padding-top:0px;margin-bottom:15px">Case <span id="editingCaseRefId">${data.refId}</span>, submitted by ${data.submittedBy}</p>
    
    <form id="type43-form" style="line-height:10px" onsubmit="handleType4Form(event, 432)">

    <label for="inputusername">Defendant's Username:</label><br><br>
    <input type="text" id="inputUsername" name="inputUsername" placeholder="Vasek_Stolba" required maxlength="20" value="${data.defendantUser}"><br><br><br>
    
    <label for="">Charges:</label><br><br>
    <input type="checkbox" id="checkbox_0" name="" value="Reckless Driving (a)" ${data.charges[0]}">
    <label for="checkbox_0">Reckless Driving (a)</label><br>
    <input type="checkbox" id="checkbox_1" name="" value="Causing a Severe Collision by Reckless Driving (b)" ${data.charges[1]}>
    <label for="checkbox_1">Causing a Severe Collision by Reckless Driving (b)</label><br>
    <input type="checkbox" id="checkbox_2" name="" value="Careless Driving (c)" ${data.charges[2]}>
    <label for="checkbox_2">Careless Driving (c)</label><br>
    <input type="checkbox" id="checkbox_3" name="" value="Disobeying a traffic authority (d) i." ${data.charges[3]}>
    <label for="checkbox_3">Disobeying a traffic authority (d) i.</label><br>
    <input type="checkbox" id="checkbox_4" name="" value="Speeding around a traffic authority (d) ii." ${data.charges[4]}>
    <label for="checkbox_4">Speeding around a traffic authority (d) ii.</label><br>
    <input type="checkbox" id="checkbox_5" name="" value="Failure to yield (e)" ${data.charges[5]}>
    <label for="checkbox_5">Failure to yield (e)</label><br>
    <input type="checkbox" id="checkbox_6" name="" value="Failure to yield to emergency vehicles (f)" ${data.charges[6]}>
    <label for="checkbox_6">Failure to yield to emergency vehicles (f)</label><br>
    <input type="checkbox" id="checkbox_7" name="" value="Speeding (g)" ${data.charges[7]}>
    <label for="checkbox_7">Speeding (g)</label><br>
    <input type="checkbox" id="checkbox_8" name="" value="Obstructing Traffic (h)" ${data.charges[8]}>
    <label for="checkbox_8">Obstructing Traffic (h)</label><br>
    <input type="checkbox" id="checkbox_9" name="" value="Parking in an Improper Manner (i)" ${data.charges[9]}>
    <label for="checkbox_9">Parking in an Improper Manner (i)</label><br>
    <input type="checkbox" id="checkbox_10" name="" value="Disobeying a Traffic Control Device (j)" ${data.charges[10]}>
    <label for="checkbox_10">Disobeying a Traffic Control Device (j)</label><br>
    <input type="checkbox" id="checkbox_11" name="" value="Causing a Severe Collision (k)" ${data.charges[11]}>
    <label for="checkbox_11">Causing a Severe Collision (k)</label><br>
    <input type="checkbox" id="checkbox_12" name="" value="Criminal Offense related to traffic (l)" ${data.charges[12]}>
    <label for="checkbox_12">Criminal Offense related to traffic (l)</label><br>
    <input type="checkbox" id="checkbox_13" name="" value="Serious Criminal Offense related to traffic (m)" ${data.charges[13]}>
    <label for="checkbox_13">Serious Criminal Offense related to traffic (m)</label><br>
    <input type="checkbox" id="checkbox_14" name="" value="Misuse of Emergency Equipment (n) i." ${data.charges[14]}>
    <label for="checkbox_14">Misuse of Emergency Equipment (n) i.</label><br>
    <input type="checkbox" id="checkbox_15" name="" value="Misuse of Miscellaneous Equipment (n) ii." ${data.charges[15]}>
    <label for="checkbox_15">Misuse of Miscellaneous Equipment (n) ii.</label><br>
    <input type="checkbox" id="checkbox_16" name="" value="Misuse of Aircrafts (n) iii." ${data.charges[16]}>
    <label for="checkbox_16">Misuse of Aircrafts (n) iii.</label><br>
    <input type="checkbox" id="checkbox_17" name="" value="Unauthorized Operation of Special Vehicles (o)" ${data.charges[17]}>
    <label for="checkbox_17">Unauthorized Operation of Special Vehicles (o)</label><br><br><br>
    
    <label for="offenseSummary">Offense Summary:</label><br><br>
    <textarea style="height:120px" id="offenseSummary" name="offenseSummary" placeholder="As I was driving past the Epsilon × Phi × IC intersection, traveling in the direction from Site Epsilon, I observed the defendant, who was driving the vehicle ahead of me, fail to yield to oncoming traffic as he made a left turn, colliding with an oncoming vehicle." required>${data.offSummary}</textarea><br><br><br>
    
    <label for="evidence">Evidence:<span style="font-size:10px"><br>Include nothing but links. Separate links by line breaks. One line per link.</span></label><br><br>
    <textarea style="height:120px" id="evidence" name="evidence" placeholder="https://example.com/evidence-a
https://example.com/evidence-b" required>${data.evidence}</textarea><br><br><br>
    
    <label for="notes">Officer Notes:</label><br><br>
    <textarea style="height:60px" id="notes" name="notes" placeholder="(Optional) The offender was ordered not to drive...">${data.offNotes}</textarea><br><br>

    <hr class="rounded"><br><br>
    <input type="checkbox" id="checkbox_supervisor" name="" value="makeSupervisor" ${data.supervisorChecked}>
    <label for="checkbox_supervisor">Make me the case supervisor</label><br><br><br>

    <label for="offenseSummary">Supervisor Notes:</label><br><br>
    <textarea style="height:120px" id="supervisorNotes" name="supervisorNotes" placeholder="The evidence clearly demonstrates the suspect disobeying road markings and driving in the opposite lane consequently causing a vehicle incident, thus satisfying the charges pursuant to subsections (a) and (b) of the Traffic Code. The driver seems to be engaging in such a manner of driving frequently and persistently even after the incident, as further demonstrated by evidence B, satisfying the charge for reckless driving.

Considering the circumstances and statutory limitations on the punishment for such offenses, I believe it is suitable to issue a 8 day suspension of driving privileges, as even though the severity of the conduct is high, a more severe punishment would be suitable primarily for worse offenses with bigger impact." required>${data.supervisorNotes}</textarea><br><br><br>
    
    <label for="sentence">Sentence:</label><br><br>
    <select id="sentence" name="sentence" onchange="handleMenu(value)" required>
      <option value="none" ${data.sentence[0]}></option>
      <option value="traffic warning" ${data.sentence[1]}>Traffic Warning</option>
      <option value="suspension of driving privileges" ${data.sentence[2]}>Suspension</option>
      <option value="revocation of driving privileges" ${data.sentence[3]}>Revocation</option>
    </select><br><br><br>

    <label for="sentenceDuration">Sentence Duration:</label><br><br>
    <input type="number" id="sentenceDuration" name="sentenceDuration" value="${data.durationValue}" placeholder="(in days)" required min="1" max="10" ${data.duration}><br><br><br>

    <label for="status">Status:</label><br><br>
    <select id="status" name="status" required>
      <option value="Pending" ${data.status[0]}>Pending</option>
      <option value="Valid" ${data.status[1]}>Valid</option>
      <option value="Invalid" ${data.status[2]}>Invalid</option>
    </select><br><br>
    
    <button id="search-button" type="submit">Edit</button>
    </form>
    <p id="type43-response"><br></p>`
            }
          }).catch(error => {
            console.error("Error:", error)
          })
      }
      if (subtype == 432) {
      document.getElementById("search-button").disabled = true
         event.preventDefault()
         var i = 0
         var charges = ""
         while (i < 18) {
           var checkbox = document.getElementById("checkbox_" + i)
           if (checkbox.checked) {
               if (charges == "") {
                 charges = checkbox.value
               } else {
                 charges += ";" + checkbox.value
               }
           }
           i = i+1
         }
         if (charges == "") {
           document.getElementById("type43-response").innerHTML = "Select at least one charge."
           document.getElementById("search-button").disabled = false
           return true
         }
         console.log(charges)
         
         var username = document.getElementById("inputUsername").value
         if (!/^[A-Za-z0-9_]{3,21}$/.test(username)) {
           document.getElementById("type43-response").innerHTML = "The username is invalid."
           document.getElementById("search-button").disabled = false
           return true
         }
         var offenseSummary = document.getElementById("offenseSummary").value.replaceAll(`
         `, "\r")
         var evidence = document.getElementById("evidence").value.replaceAll(`
         `, "\r")
         var notes = document.getElementById("notes").value.replaceAll(`
         `, "\r")
         if (document.getElementById("checkbox_supervisor").checked) {
           var makeSupervisor = "yes"
         } else {
           var makeSupervisor = "no"
         }
         var supervisorNotes = document.getElementById("supervisorNotes").value.replaceAll(`
         `, "\r")
         var sentence = document.getElementById("sentence").value
         var sentenceDuration = document.getElementById("sentenceDuration").value
         var status = document.getElementById("status").value
         var refId = document.getElementById("editingCaseRefId").innerHTML
         
         document.getElementById("type43-response").innerHTML = "Processing your request. This may take a few seconds..."
         console.log(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&username=${encodeURIComponent(username)}&charges=${encodeURIComponent(charges)}&offSummary=${encodeURIComponent(offenseSummary)}&evidence=${encodeURIComponent(evidence)}&notes=${encodeURIComponent(notes)}&makeSupervisor=${encodeURIComponent(makeSupervisor)}&supervisorNotes=${encodeURIComponent(supervisorNotes)}&sentence=${encodeURIComponent(sentence)}&sentenceDuration=${encodeURIComponent(sentenceDuration)}&status=${encodeURIComponent(status)}&refId=${encodeURIComponent(refId)}&type=432`)
         fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&username=${encodeURIComponent(username)}&charges=${encodeURIComponent(charges)}&offSummary=${encodeURIComponent(offenseSummary)}&evidence=${encodeURIComponent(evidence)}&notes=${encodeURIComponent(notes)}&makeSupervisor=${encodeURIComponent(makeSupervisor)}&supervisorNotes=${encodeURIComponent(supervisorNotes)}&sentence=${encodeURIComponent(sentence)}&sentenceDuration=${encodeURIComponent(sentenceDuration)}&status=${encodeURIComponent(status)}&refId=${encodeURIComponent(refId)}&type=432`, {
           method: 'POST'
         }).then(response => {
           if (response.ok) {
             return response.json()
           } else {
             throw new Error ('Failed to fetch response.')
           }
         }).then(data => {
           if (data.result == `Case ${refId} was successfully edited in the traffic database.`) {
             handleMenu(43)
           } else {
             document.getElementById("search-button").disabled = false
           }
           document.getElementById("type43-response").innerHTML = data.result
           
         }).catch(error => {
           console.error("Error:", error)
         })
      }
      if (subtype == 433) {        
         document.getElementById("type433-response").innerHTML = "Processing your request. This may take a few seconds..."
         fetch(`https://script.google.com/macros/s/AKfycbzd15-5tWbSQaJ7vTs2vLwn-JmUdtCuFxCXUDcZQRgelyCK18Nf-y0V-oi1GDwV-GjGNw/exec?email=${encodeURIComponent(email)}&randomNumber=${randomNumber}&type=433`, {
           method: 'POST'
         }).then(response => {
           if (response.ok) {
             return response.json()
           } else {
             throw new Error ('Failed to fetch response.')
           }
         }).then(data => {
           document.getElementById("type433-response").innerHTML = data.result
           
         }).catch(error => {
           console.error("Error:", error)
         })
      }
      }
    </script>
    <style>
      .highlight {
      background-color: #bf9000;
      }
      .highlight-red {
      background-color: #990000;
      }
      a {
      color: #efefef;
      }
      body {
      background-color: #1e2328;
      color: #efefef;
      font-family: calibri;
      }
      /* Style the search bar */
      input, select, textarea {
      width: 300px;
      height: 30px;
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 5px 10px;
      font-size: 16px;
      font-weight: bold;
      font-family: calibri;
      color: #333;
      }
      input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 2px 1px #337ab7;
      }
      input::placeholder, textarea::placeholder {
      color: #999;
      }
      input[type=checkbox] {
      height: 20px;
      width: 20px;
      vertical-align: middle;
      margin-bottom: 6px;
      }      
      /* Style the search button */
      
      button.compact {
      border: none;
      color: #fff;
      font-family: calibri;
      cursor: pointer;
      }
      
      button.styled {
      border: none;
      border-radius: 10px;
      padding: 5px 10px;
      line-height: 30px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      font-family: calibri;
      cursor: pointer;
      }
     
      button.menu {
      margin-top: 10px;
      }

      button.smaller {
      line-height: 20px;
      }
      
      button.blue {
        background-color: #337ab7;
      }
      button.blue:hover {
        background-color: #23527c;
      }
      button.blue:active {
        background-color: #1d3f5b;
      }

      button.green {
      background-color: #33b779;
      }
      button.green:hover {
      background-color: #237c52;
      }
      button.green:active {
      background-color: #1d5b3f;
      }

      button.yellow {
      background-color: #73731c;
      }
      button.yellow:hover {
      background-color: #4d4d12;
      }
      button.yellow:active {
      background-color: #33330c;
      }

      button:focus {
      outline: none;
      }
      button:disabled {
      background-color: #ccc;
      color: #999;
      cursor: not-allowed;
      }
      
      hr.rounded {
      border-top: 8px solid #337ab7;
      border-bottom: 1px solid #337ab7;
      border-radius: 5px;
      }

    </style>
  </head>
  <body onload="primary()">
    <h4 style="margin-bottom:0px">Authorization</h4>
    <p style="margin-top:5px" id="authorization-status">Loading...</p>
    <div id="g_id_onload" data-client_id="843419690229-toasgn46imbm98g5ujb9a6eujdcojfnb.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
    <div class="g_id_signin" data-type="standard"></div>
    <hr class="rounded">
    <div id="buttons">
    </div>
    <div id="dashboard">
    </div>
  </body>
</html>
